---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(warning = FALSE, message = FALSE)
```

# mk8dx

<!-- badges: start -->

<!-- badges: end -->

The mk8dx package converts lss files for MK8DX speedruns into usable table data.

## Installation

You can install the development version of mk8dx from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("sj-io/mk8dx")
```

Load the package to your library to use it.

```{r mk8dx}
library(mk8dx)
```

## `mk_lss`

### Convert lss data to a table format

Enter a filepath into `mk_lss()` to convert .lss data into a table.

```{r mk_lss}
library(dplyr)

filepath <- "inst/extdata/bell-cup.lss"

bell_cup <- mk_lss(filepath)

head(bell_cup, 4)
```

The `mk_lss()` function reads the file as xml data using `xml2`. It then gets your file's metadata variables, attempts, and split data.

Note: All split/run times are given in seconds. If runs are not completed, the attempt time will be NA. If you reset on the first track, there will be more NA variables.

To convert a folder of lss files into one table, use `mk_lss_folder()`.

```{r}
folderpath <- "inst/extdata"

all_runs <- mk_lss_folder(folderpath)

all_runs[7:14, ]
```

## `mk_repair`
### Repair incorrectly entered data

This is an experimental function to repair some columns that might have issues if your splits were entered incorrectly, or if you have old, outdated duplicate files in the same folder as more recent data.

```{r}
repaired_runs <- mk_repair(all_runs)

repaired_runs[29:32, ]
```

Current features:

- Move/correct `individual_cup` names entered into the `category` field
- Trim whitespace of characters
- Round all attempt/split times to the hundredths place.
- Fill in missing metadata variables (only for matching category/cup)
- Update outdated split data for matching run categories/variables.

## `tracks` dataset

The `tracks` dataset is a list of every track in MK8DX (as of wave 4). It can be used as a reference or to standardize/correct track names for use in tables or graphs. The dataset contains the track name, in both full (`track`) and abbreviated (`trk`) forms. The original console tag (`console`) is in a separate column to allow unique styling, i.e. "(DS) Peach Gardens", "Peach Gardens DS".

```{r tracks}
tracks[13:20, ]
```

### Join by track abbreviation

If you use standard track abbreviations[^1] as your `segment_name`, you can join `segment_name` with `tracks$trk` to create new names.

[^1]: Abbreviated names were copied from [the MK8DX Speedrunning discord](https://discord.com/channels/199214365860298752/199214365860298752/998310385545384138).

```{r abbrJoin}
bell_cup %>%
  left_join(tracks, by = c("segment_name" = "trk")) %>%
  mutate(new_segment_name = if_else(!is.na(console),
                                paste0(track, " [", console, "]"),
                                track)) %>%
  select(attempt_id, segment_name, new_segment_name, segment_time)
```

### Join by position

If your `segment_name` cannot easily be matched, you can also join by the track's position in the category. For instance, you can join by the `tracks$cup` and its corresponding position (`tracks$cup_ID`).

```{r}
bell_cup %>% 
  left_join(tracks, by = c("individual_cup" = "cup",
                           "segment_id" = "cup_ID")) %>% 
  mutate(new_segment_name = if_else(!is.na(console),
                                paste0(track, " [", console, "]"),
                                track)) %>%
  select(category, individual_cup, segment_id, segment_name, new_segment_name)
```

For other categories, you can use the 16-track name (`trks16_name`) and position (`trks16_ID`); the 48-track position (`trks48_ID`); or the unique ID of the track, `trkID`, which also functions as the eventual 96-track position.

## Credits

This package is based on [Chipdelmal's MK8D package](https://github.com/Chipdelmal/MK8D), which uses python to convert lss files to a dataframe.
